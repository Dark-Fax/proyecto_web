<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Kinetica ‚Äî Mapa de Estaciones</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="icon" href="{{ url_for('static', filename='img/Logo.png.jpg') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mapa.css') }}">
</head>

<body>

    <!-- Sidebar -->
    
    {% include 'partials/sidebar.html' %}

    <main class="content map-container">

        {% include 'partials/header_usuario.html' %}


        <div class="map-card">
            <div class="map-header">
                üìç Mapa de Estaciones de Carga en Bogot√°
            </div>

            <!-- Data container para pasar datos de Flask a JS -->
            <div id="map" data-estaciones='{{ estaciones | tojson | safe }}'></div>
        </div>
    </main>

    <script>
        // Crear mapa centrado en Bogot√°
        const map = L.map('map').setView([4.7110, -74.0721], 12);

        // Cargar tiles de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // Obtener estaciones desde el data-attribute
        const mapDiv = document.getElementById('map');
        const estaciones = JSON.parse(mapDiv.dataset.estaciones);

        console.log("Estaciones cargadas:", estaciones);

        // Iconos personalizados seg√∫n el tipo de conexi√≥n
        const iconDefault = L.icon({
            iconUrl: '{{ url_for("static", filename="img/charger-default.png") }}',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -28]
        });

        const iconFast = L.icon({
            iconUrl: '{{ url_for("static", filename="img/charger-fast.png") }}',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -28]
        });

        // Funci√≥n para elegir icono seg√∫n tipo de conexi√≥n o potencia
        function elegirIcono(conexion) {
            if (!conexion) return iconDefault;
            const tipo = conexion.ConnectionType?.Title || "";
            const potencia = conexion.PowerKW || 0;

            // Considerar fast si el tipo incluye "fast" o "r√°pida" o potencia alta (>40kW)
            if (tipo.toLowerCase().includes("fast") || tipo.toLowerCase().includes("rapida") || potencia > 40) {
                return iconFast;
            }
            return iconDefault;
        }

        // Agregar marcadores al mapa
        estaciones.forEach(e => {
            if (!e.AddressInfo) return;

            const lat = e.AddressInfo.Latitude;
            const lon = e.AddressInfo.Longitude;

            const conexion = e.Connections[0]; // Primer tipo de conexi√≥n
            const icono = elegirIcono(conexion);

            const marker = L.marker([lat, lon], { icon: icono }).addTo(map);

            // Popup con informaci√≥n de la estaci√≥n
            const urlDetalles = e.AddressInfo.RelatedURL || `https://openchargemap.org/site/poi/${e.ID}`;

            marker.bindPopup(`
                <div style="min-width:250px">
                    <strong>${e.AddressInfo.Title}</strong><br>
                    üìç ${e.AddressInfo.AddressLine1 || "Sin direcci√≥n"}<br>
                    ‚ö° ${conexion?.PowerKW || "N/A"} kW<br>
                    Tipo: ${conexion?.ConnectionType?.Title || "Desconocido"}<br>
                    <hr style="margin:4px 0;">
                    <strong>Operador / Red:</strong> ${e.DataProvider?.Title || "Desconocido"}<br>
                    <strong>Estado:</strong> ${conexion?.StatusType?.Title || "Desconocido"}<br>
                    <strong>Uso:</strong> ${conexion?.UsageType?.Title || "Desconocido"}<br>
                    <strong>Cantidad de conectores:</strong> ${e.NumberOfPoints || "N/A"}<br>
                    <strong>Conectores:</strong> ${e.Connections.map(c => c.ConnectionType?.Title).join(", ")}<br>
                    <strong>Lat/Long:</strong> ${lat.toFixed(5)}, ${lon.toFixed(5)}
                </div>
            `);
        });
    </script>
</body>
    <script src="{{ url_for('static', filename='js/Global.js') }}"></script>
</html>
